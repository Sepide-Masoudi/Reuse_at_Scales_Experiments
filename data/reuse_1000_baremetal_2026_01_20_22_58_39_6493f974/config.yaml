sma:
  version: 0.0.1
  services:
    prometheus:
      address: http://130.149.158.132:32426
  observation:
    mode: trigger
    window:
      left: 10s
      right: 10s
    targets:
      - name: reuse
        namespace: pipeline
      - name: no-reuse
        namespace: no-reuse-pipeline  
  measurements:
######### system + kepler metrics #########

    - system_cpu_usage:
        type: raw
        layer: pod
        query: container_cpu_usage_seconds_total{namespace="${namespace}", container!="", image!=""}
        unit: cpu_time_seconds
        step: 30
        target:
          - reuse

    - kepler_pod_cpu_power_watts:
        type: aggregate
        layer: pod
        query: |
         sum by (pod_name) (rate(kepler_pod_cpu_joules_total{namespace="${namespace}"}[1m]))
        unit: watts
        step: 30
        target:
          - reuse

    - kepler_pod_cpu_energy_joules:
        type: aggregate
        layer: pod
        query: |
         sum by (pod_name) (increase(kepler_pod_cpu_joules_total{namespace="${namespace}"}[1m]))
        unit: joules
        step: 30
        target:
          - reuse

    - cpu_usage_seconds_rate:
        type: aggregate
        layer: pod
        query: |
          sum by (pod) (increase(container_cpu_usage_seconds_total{namespace="${namespace}"}[1m]))
        unit: cpu_seconds_delta_per_second
        step: 30
        target:
          - reuse

    # - kepler_container_cpu_instructions:
    #     type: aggregate
    #     layer: pod
    #     query: |
    #       sum by (container_name) (
    #         rate(
    #           kepler_container_cpu_instructions_total{container_namespace="${namespace}"}[1m]
    #         )
    #       )
    #     unit: cpu_instructions_per_second
    #     step: 30
    #     target:
    #       - reuse

    - kepler_node_cpu_power_raw:
        type: raw
        layer: node
        query: rate(kepler_node_cpu_joules_total[1m])
        unit: watts
        step: 30
        target:
          - reuse

    - kepler_node_cpu_power_sum:
        type: aggregate
        layer: node
        query: sum(rate(kepler_node_cpu_joules_total[15s]))
        unit: watts
        step: 30
        target:
          - reuse

    - wall_power:
        type: raw
        layer: cluster
        query: shelly_apower_watts
        unit: watts
        step: 30
        target:
          - reuse


    - apiserver_request_rate:
        type: aggregate
        layer: cluster
        query: rate(apiserver_request_total[1m])
        unit: requests_per_second
        step: 30
        target:
          - reuse

    - apiserver_latency_95th:
        type: aggregate
        layer: cluster
        query: |
          histogram_quantile(
            0.95,
            sum(rate(apiserver_request_duration_seconds_bucket[1m])) by (le)
          )
        unit: seconds
        step: 30
        target:
          - reuse

    - pod_memory_usage:
        type: aggregate
        layer: pod
        query: sum by (pod) (container_memory_usage_bytes{namespace="${namespace}", container!="", image!=""})
        unit: bytes
        step: 30
        target:
          - reuse

    - pod_network_receive_bytes:
        type: aggregate
        layer: pod
        query: sum by (pod) (rate(container_network_receive_bytes_total{namespace="${namespace}"}[1m]))
        unit: bytes_per_second
        step: 30
        target:
          - reuse

    - pod_network_transmit_bytes:
        type: aggregate
        layer: pod
        query: sum by (pod) (rate(container_network_transmit_bytes_total{namespace="${namespace}"}[1m]))
        unit: bytes_per_second
        step: 30
        target:
          - reuse


######### argo metrics ###########

    - argo_workflows_total_count:
        type: aggregate
        layer: workflow
        query: argo_workflows_total_count{namespace="${namespace}"}
        unit: workflows
        step: 30
        target:
          - reuse

    - argo_workflows_error_count:
        type: aggregate
        layer: workflow
        query: argo_workflows_error_count{namespace="${namespace}"}
        unit: errors
        step: 30
        target:
          - reuse

    - argo_workflows_operation_duration_seconds:
        type: raw
        layer: workflow
        query: argo_workflows_operation_duration_seconds_count
        unit: seconds
        step: 30
        target:
          - reuse

    - argo_workflows_completed_total:
        type: aggregate
        layer: workflow
        query: sum by (phase) (argo_workflows_total_count{namespace="${namespace}"})
        unit: workflows
        step: 30
        target:
          - reuse

    - argo_workflows_pods_total:
        type: aggregate
        layer: pod
        query: argo_workflows_pods_total_count{namespace="${namespace}"}
        unit: pods
        step: 30
        target:
          - reuse

    #not sure what thsi measures
    - argo_workflows_average_queue_latency:
        type: raw
        layer: workflow
        query: rate(argo_workflows_queue_latency_sum[30s]) / rate(argo_workflows_queue_latency_count[30s])
        unit: seconds
        step: 30
        target:
          - reuse


    - argo_workflows_workers_busy_raw:
        type: raw
        layer: workflow
        query: argo_workflows_workers_busy_count
        unit: workers
        step: 30
        target:
          - reuse

    - argo_workflows_queue_adds_raw:
        type: raw
        layer: workflow
        query: argo_workflows_queue_adds_count
        unit: counts
        step: 30
        target:
          - reuse

    - argo_workflows_k8s_requests_raw:
        type: raw
        layer: workflow
        query: argo_workflows_k8s_request_total
        unit: requests
        step: 30
        target:
          - reuse

         
  report:
    format: csv
    location: data/reuse_1000_baremetal_${startTime}_${runHash}
    filename: "${name}_${run}.csv"