apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: synthesize-only-
  namespace: no-reuse-pipeline
spec:
  entrypoint: synthesize-only
  serviceAccountName: argo-workflow-sa

  volumes:
    - name: shared-data
      persistentVolumeClaim:
        claimName: argo-shard-pvc
    - name: temp-volume
      emptyDir:
        sizeLimit: 1Gi

  templates:
  - name: synthesize-only
    steps:
      - - name: load-data
          template: load-data-synthesize-only
      - - name: synthetic-generator
          template: synthetic-generator-synthesize-only

  - name: load-data-synthesize-only
    container:
      image: sepidmas/noreuse_scale-load-data:latest
      command: ["python", "main.py"]
      args:
        - "--input_dir"
        - "/app/data/input"
        - "--output_dir"
        - "/mnt/data/argo-shard/synthesize-only-load-data"

      env:
        - name: TMPDIR
          value: /tmp
        - name: TEMP
          value: /tmp
        - name: TMP
          value: /tmp

      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "200Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "500Mi"

      volumeMounts:
        - name: shared-data
          mountPath: /mnt/data/argo-shard
        - name: temp-volume
          mountPath: /tmp

  - name: synthetic-generator-synthesize-only
    container:
      image: sepidmas/noreuse_scale-synthetic-generator:latest
      command: ["python", "main.py"]
      args:
        - "--input_path"
        - "/mnt/data/argo-shard/synthesize-only-load-data/real-data.csv"
        - "--metadata_path"
        - "/mnt/data/argo-shard/synthesize-only-load-data/meta-data.json"
        - "--output_path"
        - "/mnt/data/argo-shard/synthesize-only-synthetic-generator/synthetic_data.csv"
        - "--num_samples"
        - "100"

      env:
        - name: TMPDIR
          value: /tmp
        - name: TEMP
          value: /tmp
        - name: TMP
          value: /tmp

      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "200Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "500Mi"

      volumeMounts:
        - name: shared-data
          mountPath: /mnt/data/argo-shard
        - name: temp-volume
          mountPath: /tmp
