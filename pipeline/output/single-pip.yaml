apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: parallel-full-data-generation-and-evaluation-
  namespace: no-reuse-pipeline
spec:
  entrypoint: parallel-full-data-generation-and-evaluation
  serviceAccountName: argo-workflow-sa
  volumes:
  - name: shared-data
    persistentVolumeClaim:
      claimName: argo-shard-pvc
  - name: temp-volume
    emptyDir:
      sizeLimit: 1Gi
      
  templates:
  - name: parallel-full-data-generation-and-evaluation
    steps:
    - - name: generate-name
        template: generate-name-parallel-full-data-generation-and-evaluation
      - name: generate-birthday
        template: generate-birthday-parallel-full-data-generation-and-evaluation
      - name: generate-address
        template: generate-address-parallel-full-data-generation-and-evaluation
    - - name: generate-id
        template: generate-id-parallel-full-data-generation-and-evaluation
    - - name: data-preprocess
        template: data-preprocess-parallel-full-data-generation-and-evaluation
    - - name: prepare-meta-data
        template: init-copy-meta-data
    - - name: synthetic-generator
        template: synthetic-generator-parallel-full-data-generation-and-evaluation
    - - name: data-quality
        template: data-quality-parallel-full-data-generation-and-evaluation
    - - name: privacy-tracking
        template: privacy-tracking-parallel-full-data-generation-and-evaluation
    - - name: cleanup-temp 
        template: cleanup-temporary-files

  - name: generate-name-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-generate-names:latest
      command: ["python","main.py"]
      args: ["--n_rows","100","--mf_ratio","0.5","--output_path","/mnt/data/argo-shard/generate-name/names.csv"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "200Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "500Mi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: generate-birthday-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-generate-birthday:latest
      command: ["python","main.py"]
      args: ["--n_rows","100","--min_age","18","--max_age","80","--output_path","/mnt/data/argo-shard/generate-birthday/birthdays.csv"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "200Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "500Mi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: generate-address-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-generate-address:latest
      command: ["python","main.py"]
      args: ["--n_rows","100","--output_path","/mnt/data/argo-shard/generate-address/addresses.csv"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "200Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "500Mi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: generate-id-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-generate-id-code:latest
      command: ["python","main.py"]
      args: ["--name_csv","/mnt/data/argo-shard/generate-name/names.csv","--birthday_csv","/mnt/data/argo-shard/generate-birthday/birthdays.csv","--output_path","/mnt/data/argo-shard/generate-id/id_data.csv"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "300Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "1Gi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: data-preprocess-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-data-preprocessor:latest
      command: ["python","main.py"]
      args: ["--input_path","/mnt/data/argo-shard/generate-id/id_data.csv","--output_path","/mnt/data/argo-shard/data-preprocess/clean_data.csv","--handle_missing","mean"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "300Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"
          ephemeral-storage: "1Gi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: init-copy-meta-data
    container:
      image: sepidmas/noreuse_scale-synthetic-generator:latest
      command: [sh, -c]
      args:
        - |
          set -e
          TARGET="/mnt/data/argo-shard/synthetic-generator"
          echo "Preparing meta-data at ${TARGET}"
          mkdir -p "${TARGET}"
          cp -r /app/meta-data.json "${TARGET}/"
          echo "Meta-data copied successfully"
      resources:
        requests:
          cpu: "50m"
          memory: "128Mi"
          ephemeral-storage: "100Mi"
        limits:
          cpu: "200m"
          memory: "256Mi"
          ephemeral-storage: "200Mi"
      volumeMounts:
        - name: shared-data
          mountPath: /mnt/data/argo-shard
        - name: temp-volume
          mountPath: /tmp

  - name: synthetic-generator-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-synthetic-generator:latest
      command: ["python","main.py"]
      args: ["--metadata_path","/mnt/data/argo-shard/synthetic-generator/meta-data.json","--input_path","/mnt/data/argo-shard/data-preprocess/clean_data.csv","--output_path","/mnt/data/argo-shard/synthetic-generator/synthetic_data.csv","--num_samples","1000"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
          ephemeral-storage: "1Gi"
        limits:
          cpu: "1000m"
          memory: "1Gi"
          ephemeral-storage: "1Gi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: data-quality-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-data-quality:latest
      command: ["python","main.py"]
      args: ["--metadata_path","/mnt/data/argo-shard/synthetic-generator/meta-data.json","--real_data_path","/mnt/data/argo-shard/data-preprocess/clean_data.csv","--synthetic_data_path","/mnt/data/argo-shard/synthetic-generator/synthetic_data.csv","--output_path","/mnt/data/argo-shard/data-quality/quality_report.json","--metrics","realistic","--output_dir","/mnt/data/argo-shard/data-quality/quality_report_HTML.html"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
          ephemeral-storage: "1Gi"
        limits:
          cpu: "1000m"
          memory: "2Gi"
          ephemeral-storage: "1Gi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: privacy-tracking-parallel-full-data-generation-and-evaluation
    container:
      image: sepidmas/noreuse_scale-privacy-tracking:latest
      command: ["python","main.py"]
      args: ["--real_data_path","/mnt/data/argo-shard/data-preprocess/clean_data.csv","--synthetic_data_path","/mnt/data/argo-shard/synthetic-generator/synthetic_data.csv","--output_path","/mnt/data/argo-shard/privacy-tracking/privacy_report.json","--risk_metric","membership_inference"]
      env:
      - name: TMPDIR
        value: /tmp
      - name: TEMP
        value: /tmp
      - name: TMP
        value: /tmp
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
          ephemeral-storage: "500Mi"
        limits:
          cpu: "500m"
          memory: "1Gi"
          ephemeral-storage: "1Gi"
      volumeMounts:
      - name: shared-data
        mountPath: /mnt/data/argo-shard
      - name: temp-volume
        mountPath: /tmp

  - name: cleanup-temporary-files
    container:
      image: alpine:latest
      command: [sh, -c]
      args:
        - |
          echo "Cleaning up temporary files..."
          # Clean up emptyDir temp volume contents
          rm -rf /tmp/* 2>/dev/null || true
          
          # Clean up any temporary directories in PVC that might have been created
          find /mnt/data/argo-shard -type d -name ".tmp*" -exec rm -rf {} + 2>/dev/null || true
          find /mnt/data/argo-shard -type f -name "*.tmp" -delete 2>/dev/null || true
          find /mnt/data/argo-shard -type f -name "temp*" -delete 2>/dev/null || true
          
          echo "Cleanup completed successfully"
      volumeMounts:
        - name: shared-data
          mountPath: /mnt/data/argo-shard
        - name: temp-volume
          mountPath: /tmp